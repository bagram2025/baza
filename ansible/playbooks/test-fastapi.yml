---
- name: Test FastAPI Installation and Connectivity
  hosts: localhost
  connection: local
  
  vars:
    fastapi_port: 8001
    fastapi_app_name: "baza-fastapi"
    project_user: "ubuntuuser"

  tasks:
    - name: Check if FastAPI service is running
      systemd:
        name: "{{ fastapi_app_name }}"
      register: service_status
      changed_when: false

    - name: Show service status
      debug:
        msg: |
          FastAPI service: {{ fastapi_app_name }}
          Active: {{ service_status.status.ActiveState }}
          SubState: {{ service_status.status.SubState }}

    - name: Check if FastAPI port is listening
      wait_for:
        port: "{{ fastapi_port }}"
        host: 127.0.0.1
        timeout: 5
      register: port_check
      ignore_errors: yes

    - name: Show port check result
      debug:
        msg: "Port {{ fastapi_port }} is {{ 'listening' if port_check is succeeded else 'NOT listening' }}"

    - name: Test FastAPI health endpoint (direct)
      uri:
        url: "http://127.0.0.1:{{ fastapi_port }}/health"
        method: GET
        status_code: 200
        timeout: 10
      register: health_direct
      ignore_errors: yes

    - name: Show direct health check result
      debug:
        msg: |
          Direct health check: {{ 'SUCCESS' if health_direct.status == 200 else 'FAILED' }}
          Status: {{ health_direct.status | default('No response') }}
          Response: {{ health_direct.json | default('No JSON response') }}

    - name: Test FastAPI root endpoint (direct)
      uri:
        url: "http://127.0.0.1:{{ fastapi_port }}/"
        method: GET
        status_code: 200
        timeout: 10
      register: root_direct
      ignore_errors: yes

    - name: Show direct root check result
      debug:
        msg: |
          Direct root check: {{ 'SUCCESS' if root_direct.status == 200 else 'FAILED' }}
          Status: {{ root_direct.status | default('No response') }}

    - name: Test FastAPI through nginx proxy
      uri:
        url: "http://127.0.0.1:8080/api/health"
        method: GET
        status_code: 200
        timeout: 10
      register: health_proxy
      ignore_errors: yes

    - name: Show proxy health check result
      debug:
        msg: |
          Proxy health check: {{ 'SUCCESS' if health_proxy.status == 200 else 'FAILED' }}
          Status: {{ health_proxy.status | default('No response') }}

    - name: Check nginx configuration for FastAPI
      shell: |
        nginx -T 2>/dev/null | grep -A 5 "location /api/" || echo "No /api/ location found"
      register: nginx_config
      changed_when: false

    - name: Show nginx configuration
      debug:
        msg: "{{ nginx_config.stdout }}"

    - name: Check FastAPI process
      shell: |
        ps aux | grep uvicorn | grep -v grep || echo "No FastAPI process found"
      register: process_check
      changed_when: false

    - name: Show FastAPI process
      debug:
        msg: "{{ process_check.stdout }}"

    - name: Create test summary
      debug:
        msg: |
          🎯 FASTAPI TEST SUMMARY
          ======================
          Service: {{ service_status.status.ActiveState }}
          Port {{ fastapi_port }}: {{ '✅ Listening' if port_check is succeeded else '❌ Not listening' }}
          Direct access: {{ '✅ Working' if health_direct.status == 200 else '❌ Failed' }}
          Proxy access: {{ '✅ Working' if health_proxy.status == 200 else '❌ Failed' }}
          
          {% if health_direct.status == 200 and health_proxy.status == 200 %}
          🚀 FastAPI is working correctly!
          {% elif health_direct.status == 200 and health_proxy.status != 200 %}
          🔧 FastAPI works directly but proxy has issues
          {% elif health_direct.status != 200 %}
          ❌ FastAPI is not working
          {% endif %}
