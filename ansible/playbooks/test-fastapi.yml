---
- name: Test FastAPI Installation and Connectivity
  hosts: localhost
  connection: local
  
  vars:
    fastapi_port: 8001
    fastapi_app_name: "baza-fastapi"
    project_user: "ubuntuuser"

  tasks:
    - name: Check if FastAPI service is running
      systemd:
        name: "{{ fastapi_app_name }}"
      register: service_status
      changed_when: false

    - name: Show service status
      debug:
        msg: |
          FastAPI service status: {{ service_status.status.ActiveState }}
          Enabled: {{ service_status.status.Enabled }}

    - name: Check if FastAPI port is listening
      wait_for:
        port: "{{ fastapi_port }}"
        host: 127.0.0.1
        timeout: 5
      register: port_check
      ignore_errors: yes

    - name: Show port check result
      debug:
        msg: "Port {{ fastapi_port }} is {{ 'listening' if port_check is succeeded else 'NOT listening' }}"

    - name: Test FastAPI health endpoint (direct)
      uri:
        url: "http://127.0.0.1:{{ fastapi_port }}/health"
        method: GET
        status_code: 200
        timeout: 10
      register: health_direct
      ignore_errors: yes

    - name: Show direct health check result
      debug:
        msg: |
          Direct health check: {{ 'SUCCESS' if health_direct.status == 200 else 'FAILED' }}
          Status: {{ health_direct.status | default('No response') }}
          Response: {{ health_direct.json | default('No JSON response') }}

    - name: Test FastAPI root endpoint (direct)
      uri:
        url: "http://127.0.0.1:{{ fastapi_port }}/"
        method: GET
        status_code: 200
        timeout: 10
      register: root_direct
      ignore_errors: yes

    - name: Show direct root check result
      debug:
        msg: |
          Direct root check: {{ 'SUCCESS' if root_direct.status == 200 else 'FAILED' }}
          Response message: {{ root_direct.json.message | default('No message') }}

    - name: Test FastAPI docs endpoint (direct)
      uri:
        url: "http://127.0.0.1:{{ fastapi_port }}/docs"
        method: GET
        timeout: 10
      register: docs_direct
      ignore_errors: yes

    - name: Show direct docs check result
      debug:
        msg: |
          Direct docs check: {{ 'SUCCESS' if docs_direct.status == 200 else 'FAILED' }}
          Status: {{ docs_direct.status | default('No response') }}

    - name: Test FastAPI through nginx proxy
      uri:
        url: "http://127.0.0.1:8080/api/health"
        method: GET
        status_code: 200
        timeout: 10
      register: health_proxy
      ignore_errors: yes

    - name: Show proxy health check result
      debug:
        msg: |
          Proxy health check: {{ 'SUCCESS' if health_proxy.status == 200 else 'FAILED' }}
          Status: {{ health_proxy.status | default('No response') }}
          Response: {{ health_proxy.json | default('No JSON response') }}

    - name: Check nginx configuration for FastAPI
      shell: |
        nginx -T 2>/dev/null | grep -A 10 "location /api/" || echo "No /api/ location found"
      register: nginx_config
      changed_when: false

    - name: Show nginx configuration
      debug:
        msg: "{{ nginx_config.stdout }}"

    - name: Check FastAPI logs
      shell: |
        journalctl -u {{ fastapi_app_name }} -n 10 --no-pager
      register: fastapi_logs
      changed_when: false
      ignore_errors: yes

    - name: Show recent FastAPI logs
      debug:
        msg: "Recent FastAPI logs:\n{{ fastapi_logs.stdout }}"

    - name: Check nginx error logs
      shell: |
        tail -10 /var/log/nginx/error.log 2>/dev/null || echo "No error log found"
      register: nginx_errors
      changed_when: false
      ignore_errors: yes

    - name: Show nginx errors
      debug:
        msg: "Recent nginx errors:\n{{ nginx_errors.stdout }}"

    - name: Test all major FastAPI endpoints
      uri:
        url: "http://127.0.0.1:{{ fastapi_port }}{{ item }}"
        method: GET
        timeout: 10
      register: endpoint_tests
      ignore_errors: yes
      loop:
        - "/health"
        - "/"
        - "/items"
        - "/info"
        - "/docs"

    - name: Show all endpoint test results
      debug:
        msg: |
          Endpoint {{ item.item }}: {{ 'âœ… SUCCESS' if item.status == 200 else 'âŒ FAILED' }} (Status: {{ item.status | default('No response') }})
      loop: "{{ endpoint_tests.results }}"

    - name: Create test summary report
      debug:
        msg: |
          ğŸ¯ FASTAPI TEST SUMMARY
          ======================
          Service: {{ 'âœ… Running' if service_status.status.ActiveState == 'active' else 'âŒ Stopped' }}
          Port {{ fastapi_port }}: {{ 'âœ… Listening' if port_check is succeeded else 'âŒ Not listening' }}
          Direct access: {{ 'âœ… Working' if health_direct.status == 200 else 'âŒ Failed' }}
          Proxy access: {{ 'âœ… Working' if health_proxy.status == 200 else 'âŒ Failed' }}
          Documentation: {{ 'âœ… Available' if docs_direct.status == 200 else 'âŒ Unavailable' }}
          
          {{ 'ğŸš€ FastAPI is working correctly!' if health_direct.status == 200 and health_proxy.status == 200 else 'ğŸ”§ There are issues with FastAPI setup' }}
